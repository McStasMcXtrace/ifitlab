<!DOCTYPE html>
<meta charset="utf-8">

<head>
  <style>
  .linkHelper {
    stroke: black;
    stroke-dasharray: 10,6;
    pointer-events: none;
  }

  /* node states */
  .disconnected {
    stroke: black;
    stroke-dasharray: 10,6;
    fill-opacity: 1;
    stroke-opacity: 1;
    fill: lightgray;
    cursor: pointer;
  }
  .passive {
    stroke: black;
    fill-opacity: 1;
    stroke-opacity: 1;
    fill: lightgray;
    cursor: pointer;
  }
  .active {
    stroke: black;
    fill: white;
    /*opacity: .5;*/
    stroke-opacity: 1;
    cursor: pointer;
  }
  .running {
    stroke: black;
    fill: #009423;
    opacity: .8;
    cursor: pointer;
  }
  .fail {
    fill: #c43838;
    opacity: .8;
    cursor: pointer;
  }

  /* connected to the "active" property on GraphicsNode */
  .selected {
    stroke: black;
    stroke-width: 2px;
  }
  .visible {
    opacity: 1;
  }
  .hidden {
    opacity: 0;
  }
  .arrow {
    fill: none;
    stroke: black;
    stroke-width: 1px;
  }
  .arrowThick {
    fill: none;
    stroke: black;
    stroke-width: 4px;
  }
  .arrowThin {
    fill: none;
    stroke: white;
    stroke-width: 2px;
  }
  .menuItem {
    border: 1px solid black;
    margin-bottom: -1px;
  }
  .menuItemSelected {
    border: 2px solid black;
    margin-bottom: -1px;
  }
  </style>
</head>

<body>


<div id="buttons" style="position:absolute;margin:auto;">
  <button id="btnUndo">Undo</button>
  <button id="btnRedo">Redo</button>
  <button id="btnRun">Run</button>
  <button id="btnSave">Save</button>
  <button id="btnLoad">Load</button>
  <button id="btnReset">Clear</button>
</div>

<div id="graph_menu_1" style="position:absolute;left:202px;overflow-y:hidden;overflow-x:hidden;margin:auto;margin-bottom:1px;"></div>
<div id="graph_menu_2" style="position:absolute;left:101px;overflow-y:hidden;overflow-x:hidden;margin:auto;margin-bottom:1px;"></div>
<div id="graph_menu_3" style="position:absolute;left:0px;overflow-y:hidden;overflow-x:hidden;margin:auto;margin-bottom:1px;"></div>

<div id="divUserData" style="position:absolute;"><fieldset><legend id="lgndNodeIdNameTypeEtc">userdata</legend>
  <table id="tblUserData" style="width:460px;">
    <tr><td colspan=2><label id="lblNodeInfo"></label></td></tr>
    <tr><td colspan=2><input type="text" id="tbxNodeLabel" style="width:440px;"/></td></tr>
  </table>
</fieldset></div>

</body>

<script src="/ifl/ifl-static/fitlab/d3.v4.min.js"></script>
<script src="/ifl/ifl-static/fitlab/jquery.min.js"></script>
<script src="/ifl/ifl-static/fitlab/jquery-ui.js"></script>
<script src="/ifl/ifl-static/fitlab/graphuilib.js"></script>
<script src="/ifl/ifl-static/fitlab/graphui.js"></script>
<script src="/ifl/ifl-static/fitlab/plainui.js"></script>
<script src="/ifl/ifl-static/fitlab/nodetypes.js"></script>
<script src="/ifl/ifl-static/fitlab/plotfuncs.js"></script>

<script>
clearUserDataPanel = function() {
  $("#lblNodeInfo").text("");
  $("#tbxNodeLabel").val("");
  $("#lgndNodeIdNameTypeEtc").html("userdata");
  $(".dynamicProperty").remove();
}
setUserData = function(node) {
  clearUserDataPanel();

  if (!node) return;
  if (node.info) $("#lblNodeInfo").text("Info: " + JSON.stringify(node.info));
  $("#tbxNodeLabel").val(node.label);
  $("#lgndNodeIdNameTypeEtc").html("id: "+node.id+"; type: "+node.type+"("+node.basetype+")");

  // Why does "literal" node type get special treatment?
  // Because, it is currently the only way we have of entering actual JSON data into the graph environment...
  if (node.basetype == "object_literal") {
    let rowid = "row_42"; // some key strings have whitespaces in them...
    $("#tblUserData tbody")
      .append('<tr id="'+rowid+'" class="dynamicProperty"><td><textarea rows="20" cols="64"></textarea></td></tr>');
    $("#"+rowid +" textarea")
      .val(JSON.stringify(node.userdata, null, 2))
      .focus( () => {
        let tarea = $("#"+rowid +" textarea");
        if (tarea.val() == "null") tarea.val("");
      })
      .change( () => {
        let tarea = $("#"+rowid +" textarea");
        if (tarea.val() == "") tarea.val("null");
        intface.node_data(node.id, tarea.val());
      });
  }
  else {
    for (let key in node.userdata)
    {
      let rowid = "row_" + node.id + key.replace(/ /g, '_'); // some key strings have whitespaces in them...
      if (node.edit) {
        // build properties with textboxes for values
        $("#tblUserData tbody")
          .append('<tr id="'+rowid+'" class="dynamicProperty"><td><label/></td><td><input type="text"/></td></tr>');
        $("#"+rowid +" input")
          .val(JSON.stringify(node.userdata[key]))
          .focus( () => {
            let tarea = $("#"+rowid +" input");
            if (tarea.val() == "null") tarea.val("");
          })
          .focusout( () => {
            let tarea = $("#"+rowid +" input");
            if (tarea.val() == "") tarea.val("null");
          })
          .change( () => {
            let tarea = $("#"+rowid +" input");
            if (tarea.val() == "") tarea.val("null");
            try {
              node.userdata[key] = JSON.parse(tarea.val());
              intface.node_data(node.id, JSON.stringify(node.userdata));
            }
            catch(err) {
              tarea.val("null");
            }
          });

        $("#"+rowid +" label")
          .html(key+': ');
      }
      else {
        // build properties with labels for values
        $("#tblUserData tbody")
          .append('<tr id="'+rowid+'" class="dynamicProperty"> <td><label id="key_'+rowid+'"/></td> <td><label id="value_'+rowid+'"/></td> </tr>');
        $("#key_"+rowid)
          .html(key+': ');
        $("#value_"+rowid)
          .html(JSON.stringify(node.userdata[key]));
      }

    }
  }
}

let intface = null;
let menu = null;

$(document).ready(() => {
  // set up events
  $("#btnUndo").click( () => { intface.undo() });
  $("#btnRedo").click( () => { intface.redo() });
  $("#btnRun").click( () => { intface.runSelectedNode() });
  $("#btnSave").click( () => { intface.saveGraphDef() });
  $("#btnLoad").click( () => { intface.loadGraphDef() })
  $("#btnReset").click( () => { intface.reset() });

  // construct graph engine and add listeners
  intface = new GraphInterface();
  intface.addNodeRunReturnListener( (node) => {
    // clear previous subwindow elements with this id
    let x_y = removeSubWindow(node.id);

    if (node.plotdata) {
      // create a subwindow now the coast is clear
      let xpos = node.gNode.x + 150;
      let ypos = node.gNode.y - 100;
      let width = 330;
      let height = 220;
      if (x_y) { xpos=x_y[0]; ypos=x_y[1]; }
      let title = node.label + '(' + node.id + ')';
      let subwinid_containerid = createSubWindow(node.id, title, xpos, ypos, width);

      // plot into the subwindow
      let plotbranch = d3.select('#'+subwinid_containerid[0]).append("svg");
      let pltdata = node.plotdata;
      pltdata.title='';
      pltdata.w = width;
      pltdata.h = height;
      if (pltdata.ndims == 1) plot_1d(pltdata, plotbranch);
      if (pltdata.ndims == 2) plot_2d(pltdata, plotbranch);

      // add the @node_delete cleanup function
      intface.addNodeDeletedListener( (id) => {
        if (id == node.id) $("#"+subwinid_containerid[1]).remove();
      });
    }

    if (node.userdata) {
      setUserData(intface.getSelectedNode());
    }
  }, null);

  // user data controls
  let lft = window.innerWidth - $("#divUserData").width();
  $("#divUserData").css({ left: lft, });
  $("#divUserData").draggable();
  intface.addNodeSelectionListener( (node) => {
    if (node) { setUserData(node); }
    else clearUserDataPanel();
  }, null);
  intface.addUiUpdateListener( () => {
    if (intface.graphData.selectedNode) {
      setUserData(intface.getSelectedNode());
    }
  }, null);
  $("#tbxNodeLabel").change( () => {
    intface.pushSelectedNodeLabel($("#tbxNodeLabel").val());
  });

  // create node menu
  let menuCB = intface.setCreateNodeConf.bind(intface)
  menu = new NodeTypeMenu(menuCB, 'graph_menu_1', 'handles');
  menu = new NodeTypeMenu(menuCB, 'graph_menu_2', 'classes');
  menu = new NodeTypeMenu(menuCB, 'graph_menu_3', 'functions');

  // load graph and run
  // why is this needed to get rid of the "self.draggable is null" error message?
  intface.updateUi();
  intface.loadGraphDef(); // this also updates the ui...
});
</script>
</html>
